name: ðŸ§ª QGIS tests

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - master
      - release-**
      - queued_ltr_backports
    paths:
    - 'src/**'
    - 'external/**'
    - 'python/**'
    - 'tests/**'
    - 'CMakeLists.txt'
    - '.github/workflows/run-tests.yml'
    - '.docker/**'
    - '.ci/**'
  pull_request:
    branches:
      - master
      - release-**
      - queued_ltr_backports
    # paths cannot be filtered on this workflow on pull request as it is a required one in the branch protection
    # feature request and hacks: https://github.community/t/feature-request-conditional-required-checks/16761

permissions:
  contents: read

jobs:
  run-tests:
    name: Run tests
    env:
      QGIS_WORKSPACE: ${{ github.workspace }} # used in docker compose

    runs-on: self-hosted

    strategy:
      matrix:

        include:
          - qt-version: 6
            distro: ubuntu
            distro-version: '25.10'
            docker-target: binary-only
            test-blocklist-file: .ci/test_blocklist_qt6_ubuntu.txt
            test-batch: ALL_BUT_PROVIDERS

      fail-fast: false

    steps:
    
      - name: Run tests
        id: tests
        env:
          TEST_BATCH: ${{matrix.test-batch}}
          QGIS_COMMON_GIT_DIR: ${{ github.workspace }}
          GITHUB_SHA: ${{ github.sha }}
          TEST_BLOCKLIST_FILE: ${{matrix.test-blocklist-file}}
        run: |
          DOCKERFILE=$( ( [[ ${{ matrix.test-batch }} == "ORACLE"   ]] && echo "docker-compose-testing-oracle.yml" ) \
                     || ( [[ ${{ matrix.test-batch }} == "POSTGRES" ]] && echo "docker-compose-testing-postgres.yml" ) \
                     || ( [[ ${{ matrix.test-batch }} == "SQLSERVER" ]] && echo "docker-compose-testing-mssql.yml" ) \
                     || echo "docker-compose-testing.yml" )
          [[ ${{ matrix.test-batch }} == "ORACLE" ]] && sudo rm -rf /usr/share/dotnet/sdk
          echo "TEST_BATCH=$TEST_BATCH"
          echo "DOCKERFILE=$DOCKERFILE"
          echo "TEST_BLOCKLIST_FILE=$TEST_BLOCKLIST_FILE"
          mkdir -p /tmp/webdav_tests && chmod -R 777 /tmp/webdav_tests
          mkdir -p /tmp/minio_tests/test-bucket && chmod -R 777 /tmp/minio_tests